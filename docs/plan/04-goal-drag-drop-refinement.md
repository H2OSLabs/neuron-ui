# 目标 4: 拖拉拽细节调整

> 在自动生成的页面基础上，通过可视化编辑器进行人工微调

---

## 目标分析

### 与之前的区别

之前的目标 2 是"从零拖拉拽搭建页面"。现在调整为：**页面已经由目标 3 自动生成，拖拉拽编辑器是"最后一公里"的细节调整工具**。

```
之前: 空白画布 → 拖拽组件 → 配置属性 → 完成页面      (从零搭建)
现在: API+TaskCase → 自动生成页面 → 编辑器微调 → 完成  (生成+调整)
```

### 编辑器的定位

| 角色 | 不是 | 是 |
|------|------|---|
| 页面来源 | 从空白画布手动搭建 | 由生成引擎自动输出 |
| 编辑粒度 | 全量搭建 | 微调：布局、属性、文案、样式 |
| 使用者 | 开发者 | 运营人员 / 产品经理 |
| 核心价值 | 替代写代码 | 补全自动生成无法覆盖的细节 |

## 编辑器需要支持的调整类型

### 1. 布局调整

| 操作 | 说明 | 示例 |
|------|------|------|
| 调整顺序 | 拖拽组件改变排列顺序 | 把"标签"列移到"状态"列前面 |
| 调整大小 | 拖拽手柄改变宽高 | 把侧边编辑面板从 396px 改为 480px |
| 显示/隐藏 | 切换组件可见性 | 隐藏"创建者"列（数据仍在，只是不展示） |
| 增删组件 | 添加或删除组件 | 在工具栏添加一个"导出"按钮 |

### 2. 属性调整

| 操作 | 说明 | 示例 |
|------|------|------|
| 修改文案 | 改按钮/标题/占位符文字 | "创建赛事" → "发起新赛事" |
| 修改颜色 | 从 Token 下拉选择颜色 | 把状态 Badge 的 "active" 从 lime 改为 green |
| 修改变体 | 切换组件的展示形态 | Dialog → Sheet（创建表单从弹窗改为侧边面板） |
| 修改尺寸 | 切换组件大小 | 按钮从 md(32px) 改为 lg(36px) |

### 3. 数据绑定调整

| 操作 | 说明 | 示例 |
|------|------|------|
| 修改列映射 | 改变表格列绑定的字段 | 添加一列展示"参赛人数" |
| 修改排序 | 设置默认排序字段 | 默认按"创建日期"倒序 |
| 修改过滤 | 调整过滤条件 | 添加"日期范围"过滤 |
| 修改表单字段 | 增删编辑表单中的字段 | 创建表单中去掉"标签"字段 |

### 4. 样式微调

| 操作 | 说明 | 示例 |
|------|------|------|
| 间距调整 | 从 Token 选择间距值 | 工具栏和表格之间的间距从 16px 改为 24px |
| 圆角调整 | 从 Token 选择圆角值 | 卡片圆角从 12px 改为 20px |
| 对齐方式 | 调整内容对齐 | 奖金列右对齐 |

### 5. 组件替换与子组件修改（核心调整场景）

当自动生成的页面 UI 不符合需求时，需要对组件进行 **整体替换** 或 **内部子组件修改**。这是编辑器最关键的能力。

#### 场景说明

自动生成引擎根据 `GET /api/competitions` + TaskCase 中的 `list` 意图，默认生成了 NDataTable：

```
┌──────────────────────────────────────────────────┐
│ NDataTable (自动生成)                              │
│ ┌────────┬────────┬────────┬────────┬──────────┐ │
│ │ 赛事名称│  状态   │  奖金   │ 创建者  │   操作    │ │
│ │ NText  │ NBadge │ NText  │NAvatar │NDropdown │ │
│ ├────────┼────────┼────────┼────────┼──────────┤ │
│ │ 第一届  │ 进行中  │ ¥5000  │ 👤张三  │ ··· │ │
│ │ 第二届  │ 草稿    │ ¥3000  │ 👤李四  │ ··· │ │
│ └────────┴────────┴────────┴────────┴──────────┘ │
└──────────────────────────────────────────────────┘
```

但运营觉得表格太死板，想换成卡片网格布局，或者想修改某列的展示组件。

#### 操作类型 A: 整体替换 — 换掉容器组件

将整个 NDataTable 替换为 NCard 网格布局，同时保留数据绑定：

```
操作步骤:
1. 选中 NDataTable
2. 点击 [替换组件]
3. 编辑器展示"同为 GET 展示类"的可替换组件列表:
   • NCard 网格    ← 选择这个
   • NCarousel 轮播
   • NScrollArea 列表
   • NAccordion 折叠
4. 选择 NCard 网格
5. 编辑器自动映射字段:
   - name → NCard.title (NText)
   - cover_image → NCard.media slot
   - status → NCard.badge slot (NBadge)
   - created_by → NCard.footer (NAvatar)
6. 保留原有 dataSource 绑定 (GET /api/competitions)
```

**替换后效果:**

```
┌───────────┐  ┌───────────┐  ┌───────────┐
│ ┌───────┐ │  │ ┌───────┐ │  │ ┌───────┐ │
│ │ 封面图 │ │  │ │ 封面图 │ │  │ │ 封面图 │ │
│ └───────┘ │  │ └───────┘ │  │ └───────┘ │
│ 第一届大赛 │  │ 第二届大赛 │  │ 第三届大赛 │
│ [进行中]   │  │ [草稿]    │  │ [已结束]   │
│ 👤张三     │  │ 👤李四     │  │ 👤王五     │
└───────────┘  └───────────┘  └───────────┘
```

**Page Schema 变化:**

```jsonc
// 替换前
{
  "id": "data-table",
  "component": "NDataTable",
  "binding": { "dataSource": "competitionList", "columns": [...] }
}

// 替换后 — dataSource 保留，展示方式改变
{
  "id": "card-grid",
  "component": "NCardGrid",    // 替换为卡片网格
  "props": { "columns": 3, "gap": "md" },
  "binding": {
    "dataSource": "competitionList",  // ★ 数据绑定保留不变
    "itemTemplate": {                  // 每个数据项的渲染模板
      "component": "NCard",
      "props": { "variant": "cover-top", "radius": "lg" },
      "fieldMapping": {
        "media": { "field": "cover_image", "component": "NImage" },
        "title": { "field": "name", "component": "NText" },
        "badges": { "field": "status", "component": "NBadge" },
        "footer": { "field": "created_by", "component": "NAvatar" }
      }
    }
  }
}
```

#### 操作类型 B: 子组件替换 — 换掉内部某个展示组件

不换容器，只修改 NDataTable 中某列的渲染组件：

```
操作步骤:
1. 选中 NDataTable 中的"状态"列
2. 当前渲染组件: NBadge
3. 点击 [替换列组件]
4. 编辑器展示"适合展示 string:enum 类型"的组件列表:
   • NBadge (当前)
   • NSwitch (布尔切换样式展示)
   • NText (纯文本)
   • NProgress (进度条，如果 enum 有顺序含义)
5. 选择 NSwitch
6. 配置映射: active → on, draft/ended → off
```

```jsonc
// 替换前: status 列用 NBadge 展示
{
  "field": "status",
  "header": "状态",
  "component": "NBadge",
  "colorMap": { "draft": "yellow", "active": "lime", "ended": "gray-07" }
}

// 替换后: status 列改用 NSwitch 展示
{
  "field": "status",
  "header": "状态",
  "component": "NSwitch",
  "valueMap": { "active": true, "draft": false, "ended": false },
  "binding": { "onChange": { "api": "PUT /api/competitions/{id}", "field": "status" } }
}
```

#### 操作类型 C: 子组件组合 — 在一个位置放多个组件

一个展示区域需要组合多个组件：

```
操作步骤:
1. 选中"赛事名称"列
2. 当前只有 NText
3. 点击 [添加子组件]
4. 在 NText 上方插入 NAvatar (显示创建者头像)
5. 配置 NAvatar 绑定 created_by.avatar 字段
6. 结果: 每行显示 "👤 赛事名称" 的组合效果
```

```jsonc
// 修改前: 纯文本
{
  "field": "name",
  "header": "赛事名称",
  "component": "NText"
}

// 修改后: 头像+文本组合
{
  "field": "name",
  "header": "赛事名称",
  "component": "NComposite",            // 组合容器
  "layout": "horizontal",
  "gap": "sm",
  "children": [
    { "component": "NAvatar", "props": { "size": "sm" }, "binding": { "field": "created_by.avatar" } },
    { "component": "NText", "binding": { "field": "name" } }
  ]
}
```

#### 编辑器如何支持这些操作

##### 替换建议算法

当用户点击 [替换组件] 时，编辑器需要智能推荐可替换的组件：

```
输入:
  - 当前组件类型 (NDataTable)
  - 当前绑定的 API 类型 (GET)
  - 当前绑定的字段类型 (array:object)

查询 component-api-mapping.json:
  - 找到所有 API 角色 = "GET 展示" 的组件
  - 找到所有能展示 "array:object" 类型的组件
  - 取交集 → 推荐列表

输出:
  - NCard 网格 (推荐 — 同为列表展示)
  - NCarousel (轮播展示)
  - NScrollArea + NCard (滚动卡片列表)
  - NAccordion (折叠列表)
```

##### 字段自动映射

替换容器组件后，字段需要自动映射到新组件的 slot：

```
NDataTable 列 → NCard slot 映射规则:
  string:image → media slot (封面/图片区)
  string (第一个) → title (标题)
  string (第二个) → body (正文)
  string:enum → badges slot (标签)
  object:user → footer (底部用户信息)
  date → footer (底部日期)
  number → body (正文数值)
```

##### 属性面板中的替换入口

```
┌────────────────────────────────────┐
│ 属性面板                            │
│ ────────────────────                │
│ 选中: NDataTable                    │
│ ────────────────────                │
│ [🔄 替换组件]  [✏️ 编辑属性]       │
│                                    │
│ 列配置:                             │
│ ┌──────────────────────────────┐   │
│ │ 赛事名称                      │   │
│ │ 渲染: NText  [🔄 替换] [➕]  │   │
│ ├──────────────────────────────┤   │
│ │ 状态                          │   │
│ │ 渲染: NBadge [🔄 替换] [➕]  │   │
│ ├──────────────────────────────┤   │
│ │ 创建者                        │   │
│ │ 渲染: NAvatar [🔄 替换] [➕] │   │
│ └──────────────────────────────┘   │
│                                    │
│ [🔄 替换] = 替换当前渲染组件        │
│ [➕]     = 在此列添加组合组件       │
└────────────────────────────────────┘
```

## 编辑器界面

```
┌──────────┬───────────────────┬───────────────────────┐
│ 组件面板  │     画布区域       │     属性编辑面板       │
│ (可折叠)  │                   │                       │
│          │  ┌─────────────┐  │  选中: NDataTable      │
│ [追加组件]│  │  工具栏      │  │  ─────────────         │
│          │  │ [搜索][筛选] │  │  数据源: GET /api/...  │
│ • Button │  │        [新建]│  │  ─────────────         │
│ • Badge  │  ├─────────────┤  │  列配置:               │
│ • Input  │  │             │  │  ☑ 赛事名称  [NText]   │
│ • Card   │  │  数据表格    │  │  ☑ 状态      [NBadge]  │
│ • ...    │  │             │  │  ☐ 创建者    [NAvatar]  │
│          │  │             │  │  ─────────────         │
│          │  │             │  │  行操作:               │
│          │  ├─────────────┤  │  ☑ 编辑                │
│          │  │ [创建弹窗]   │  │  ☑ 删除                │
│          │  │ [编辑面板]   │  │                       │
│          │  │ [删除确认]   │  │                       │
│          │  └─────────────┘  │                       │
├──────────┴───────────────────┴───────────────────────┤
│  [撤销] [重做] | [预览] [导出JSON] [发布]              │
└──────────────────────────────────────────────────────┘
```

### 关键设计原则

1. **颜色/间距/圆角只能从 Token 下拉选择** — 不提供自由输入，从源头保证设计合规
2. **数据绑定可视化** — 展示每个组件绑定了哪个 API 和哪个字段，可以点击修改
3. **组件替换建议** — 当用户想换组件时，只展示符合当前接口类型的组件（由目标 2 的映射规则约束）
4. **生成标记** — 自动生成的内容有标记，与手动添加的内容区分

## 编辑器与生成引擎的关系

```
生成引擎 (目标 3)                    编辑器 (目标 4)
    │                                    │
    │  输出 Page Schema                  │  读取 Page Schema
    │  (含 dataSources + binding)        │  渲染到画布
    │                                    │
    ▼                                    ▼
┌────────────────┐              ┌────────────────┐
│  Page Schema   │──── 传递 ───→│  Page Schema   │
│  (自动生成版)   │              │  (编辑后版本)   │
│                │              │                │
│ • 组件树        │              │ • 组件树 (调整后)│
│ • 数据绑定      │              │ • 数据绑定 (保留)│
│ • 默认属性      │              │ • 属性 (微调后)  │
└────────────────┘              └────────────────┘
                                        │
                                        ▼
                                ┌────────────────┐
                                │  发布/导出      │
                                │  • JSON 导出    │
                                │  • HTML 导出    │
                                │  • 直接发布     │
                                └────────────────┘
```

### 重新生成策略

当 API 发生变化时（如新增字段），用户可以选择：

| 策略 | 说明 |
|------|------|
| 全量重新生成 | 丢弃手动调整，重新生成整个页面 |
| 增量合并 | 保留手动调整，只添加新字段/组件 |
| 对比预览 | 展示新旧差异，用户逐项决定是否接受 |

## 技术方案

| 层面 | 方案 |
|------|------|
| 画布渲染 | 复用 PageRenderer (与目标 3 生成预览相同的渲染器) |
| 拖拽引擎 | dnd-kit (React 拖拽库) |
| 状态管理 | Zustand + temporal 中间件 (undo/redo) |
| 属性面板 | 基于组件 Schema 自动生成编辑器 |
| 数据绑定面板 | 读取 Page Schema 中的 binding 字段，可视化展示 |

## 验收标准

| # | 标准 |
|---|------|
| 1 | 自动生成的 Page Schema 可直接在编辑器中打开和渲染 |
| 2 | 运营人员 5 分钟内可完成对自动生成页面的微调 |
| 3 | 所有属性调整只能使用 Token 值，保证设计合规 |
| 4 | 支持撤销/重做至少 50 步 |
| 5 | 修改后的 Page Schema 保留原有数据绑定 |
| 6 | 支持增量合并（API 变化后不丢失手动调整） |

## 任务拆解

| 优先级 | 任务 |
|--------|------|
| P0 | PageRenderer (Schema → React 渲染，与目标 3 共用) |
| P0 | 画布拖拽排序 |
| P0 | 属性编辑面板 (基于 Schema 自动生成) |
| P1 | 数据绑定可视化面板 |
| P1 | 组件增删功能 |
| P1 | 撤销/重做 |
| P2 | 预览模式 (桌面/平板/手机) |
| P2 | 增量合并 (API 变更后保留手动调整) |
| P3 | 导出 JSON / HTML |
| P3 | 模板保存与复用 |
| P3 | 发布流程 |
